package LoginSimulate;
import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.geom.AffineTransform;
import java.awt.image.BufferedImage;
import java.util.Random;
import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.HashMap;

public class LoginApp {
    static boolean captchaVerified = false;
    static String currentCaptchaText = "";
    static String generatedOTP = "";
    static String guestEmail = "";
    static boolean guestClicked = false;
    static String stoEmail = "";
    public static String stoUsername = "";

    public static String generateCaptchaText(int length) {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        StringBuilder captcha = new StringBuilder();
        Random random = new Random();

        for (int i = 0; i < length; i++) {
            int index = random.nextInt(chars.length());
            captcha.append(chars.charAt(index));
        }
        return captcha.toString();
    }

    public static String generateOTP(int length) {
        String digits = "0123456789";
        StringBuilder otp = new StringBuilder();
        Random random = new Random();

        for (int i = 0; i < length; i++) {
            int index = random.nextInt(digits.length());
            otp.append(digits.charAt(index));
        }
        return otp.toString();
    }

    public static BufferedImage generateCaptchaImage(String captchaText) {
        int width = 300;
        int height = 100;
        BufferedImage captchaImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        Graphics2D g = (Graphics2D) captchaImage.getGraphics();

        g.setColor(new Color(180, 220, 240));
        g.fillRect(0, 0, width, height);

        g.setFont(new Font("Serif", Font.BOLD, 40));
        Random rand = new Random();
        int x = 20;

        for (char c : captchaText.toCharArray()) {
            AffineTransform originalTransform = g.getTransform();
            double rotation = (rand.nextDouble() - 0.5) * 0.4;
            double scale = 1 + (rand.nextDouble() - 0.5) * 0.3;
            g.rotate(rotation, x, 50);
            g.scale(scale, scale);
            g.setColor(new Color(10, 10, rand.nextInt(150) + 100));

            g.drawString(String.valueOf(c), x, 50 + rand.nextInt(20) - 10);

            g.setTransform(originalTransform);
            x += 40;
        }

        g.setColor(Color.GRAY);
        for (int i = 0; i < 8; i++) {
            int x1 = rand.nextInt(width);
            int y1 = rand.nextInt(height);
            int x2 = rand.nextInt(width);
            int y2 = rand.nextInt(height);
            g.drawLine(x1, y1, x2, y2);
        }

        g.dispose();
        return captchaImage;
    }

    static HashMap<String, String> accountsMap = new HashMap<>();
    public static void main(String[] args) {
        loadAccounts("index.txt");
        JFrame frame = new JFrame("ƒêƒÉng nh·∫≠p v√†o Minesweeper");
        frame.setSize(400, 300);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setLayout(new GridLayout(4, 1)); // Thay ƒë·ªïi s·ªë h√†ng ƒë·ªÉ c√≥ th√™m d√≤ng nh·ªè
        frame.setResizable(false);
    
        JPanel panelLogin = new JPanel(new GridLayout(2, 2));
        JLabel labelUsername = new JLabel("    T√™n ƒëƒÉng nh·∫≠p:");
        JTextField textUsername = new JTextField();
        JLabel labelPassword = new JLabel("    M·∫≠t kh·∫©u:");
        JPasswordField textPassword = new JPasswordField();
    
        JButton btnTogglePassword = new JButton("üôà");
        btnTogglePassword.addActionListener(new ActionListener() {
            private boolean passwordVisible = false;
    
            @Override
            public void actionPerformed(ActionEvent e) {
                if (passwordVisible) {
                    textPassword.setEchoChar('*');
                    btnTogglePassword.setText("üôà");
                } else {
                    textPassword.setEchoChar((char) 0);
                    btnTogglePassword.setText("üëÅÔ∏è");
                }
                passwordVisible = !passwordVisible;
            }
        });
    
        panelLogin.add(labelUsername);
        panelLogin.add(textUsername);
        panelLogin.add(labelPassword);
    
        JPanel passwordPanel = new JPanel(new BorderLayout());
        passwordPanel.add(textPassword, BorderLayout.CENTER);
        passwordPanel.add(btnTogglePassword, BorderLayout.EAST);
        panelLogin.add(passwordPanel);
    
        JCheckBox checkHuman = new JCheckBox("I am human");
        JPanel panelCheckbox = new JPanel(new FlowLayout(FlowLayout.CENTER));
        panelCheckbox.add(checkHuman);
        JButton btnLogin = new JButton("ƒêƒÉng nh·∫≠p");
        JButton btnExit = new JButton("Tho√°t");
    
        JPanel panelButtons = new JPanel(new FlowLayout(FlowLayout.CENTER));
        panelButtons.add(btnLogin);
        panelButtons.add(btnExit);
    
        JLabel guestLoginLabel = new JLabel("ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n kh√°ch", JLabel.CENTER);
        guestLoginLabel.setForeground(Color.BLUE);
        guestLoginLabel.setCursor(new Cursor(Cursor.HAND_CURSOR));
    
        JLabel viewAccountLabel = new JLabel("Qu√™n t√†i kho·∫£n?", JLabel.CENTER);
        viewAccountLabel.setForeground(Color.BLUE);
        viewAccountLabel.setCursor(new Cursor(Cursor.HAND_CURSOR));
    
        // Th√™m d√≤ng n√†y sau khi b·∫°n ƒë√£ khai b√°o c√°c th√†nh ph·∫ßn c·ªßa JFrame (tr∆∞·ªõc khi th√™m frame.setVisible(true);)
        JPanel guestAndViewPanel = new JPanel(new GridLayout(2, 1)); // T·∫°o JPanel m·ªõi v·ªõi 2 h√†ng
        guestAndViewPanel.add(guestLoginLabel); // Th√™m d√≤ng ƒëƒÉng nh·∫≠p kh√°ch v√†o panel
        guestAndViewPanel.add(viewAccountLabel); // Th√™m d√≤ng xem t√†i kho·∫£n v√†o panel
    
        // Thay th·∫ø ph·∫ßn th√™m guestLoginLabel v√† viewAccountLabel v√†o frame b·∫±ng vi·ªác th√™m panel m·ªõi v√†o frame
        frame.add(panelLogin);
        frame.add(panelCheckbox);
        frame.add(panelButtons);
        frame.add(guestAndViewPanel); // Th√™m panel ch·ª©a 2 d√≤ng v√†o frame
    
        frame.setVisible(true);
        frame.setLocationRelativeTo(null);
    
        viewAccountLabel.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                // Ki·ªÉm tra CAPTCHA tr∆∞·ªõc khi ti·∫øp t·ª•c
                if (!captchaVerified) {
                    JOptionPane.showMessageDialog(frame, "B·∫°n ph·∫£i x√°c minh CAPTCHA tr∆∞·ªõc khi xem t√†i kho·∫£n.", "L·ªói", JOptionPane.ERROR_MESSAGE);
                    return;
                }
        
                boolean validEmail = false;
                String enteredEmail = ""; // Khai b√°o bi·∫øn ƒë·ªÉ l∆∞u email nh·∫≠p v√†o
                
                while (!validEmail) {
                    enteredEmail = JOptionPane.showInputDialog(frame, "Nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ nh·∫≠n m√£ OTP:", "Nh·∫≠p email", JOptionPane.QUESTION_MESSAGE);
                    
                    if (enteredEmail == null) {
                        return; // N·∫øu ng∆∞·ªùi d√πng nh·∫•n H·ªßy
                    }
                    
                    if (enteredEmail.isEmpty()) {
                        JOptionPane.showMessageDialog(frame, "Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng. Vui l√≤ng th·ª≠ l·∫°i.", "L·ªói", JOptionPane.ERROR_MESSAGE);
                        continue;
                    }
        
                    // T√¨m ki·∫øm email trong accountsMap
                    boolean emailFound = false;
                    for (String key : accountsMap.keySet()) {
                        String[] parts = accountsMap.get(key).split(" ");
                        if (parts.length >= 2 && parts[1].equals(enteredEmail)) {
                            emailFound = true;
                            break;
                        }
                    }

                    if (emailFound) { // Ki·ªÉm tra xem email c√≥ trong accountsMap kh√¥ng
                        validEmail = true; // Email h·ª£p l·ªá
                        // G·ªçi FirstClass ƒë·ªÉ thi·∫øt l·∫≠p gi√° tr·ªã
                        stoEmail = enteredEmail;
                    } else {
                        JOptionPane.showMessageDialog(frame, "Email ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√≠. Vui l√≤ng li√™n h·ªá Admin ƒë·ªÉ ƒë∆∞·ª£c gi√∫p ƒë·ª°.", "L·ªói", JOptionPane.ERROR_MESSAGE);
                    }
                }
        
                generatedOTP = generateOTP(6);
                JOptionPane.showMessageDialog(frame, "G·ª≠i m√£ OTP th√†nh c√¥ng! H√£y ki·ªÉm tra email " + enteredEmail + ".", "OTP Sent", JOptionPane.INFORMATION_MESSAGE);
                showFakeGmailWindow(frame, enteredEmail, generatedOTP);
                showOTPInputDialog(frame, generatedOTP);
            }
        });
        
    
        guestLoginLabel.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                if (!captchaVerified) {
                    JOptionPane.showMessageDialog(frame, "B·∫°n ph·∫£i x√°c minh CAPTCHA tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p.", "L·ªói", JOptionPane.ERROR_MESSAGE);
                    return;
                }
            
                boolean validEmail = false;
                while (!validEmail) {
                    guestEmail = JOptionPane.showInputDialog(frame, "Nh·∫≠p email c·ªßa b·∫°n ƒë·ªÉ nh·∫≠n m√£ OTP:", "Nh·∫≠p email", JOptionPane.QUESTION_MESSAGE);
                    
                    if (guestEmail == null) {
                        return;
                    }
                    
                    if (guestEmail.isEmpty()) {
                        JOptionPane.showMessageDialog(frame, "Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng. Vui l√≤ng th·ª≠ l·∫°i.", "L·ªói", JOptionPane.ERROR_MESSAGE);
                        continue;
                    }
            
                    if (guestEmail.matches("^[\\w.-]+@[\\w.-]+\\.com$")) {
                        validEmail = true;
                    } else {
                        JOptionPane.showMessageDialog(frame, "Email kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng (vd: user@example.com).", "L·ªói", JOptionPane.ERROR_MESSAGE);
                    }
                }
            
                generatedOTP = generateOTP(6);
                JOptionPane.showMessageDialog(frame, "G·ª≠i m√£ OTP th√†nh c√¥ng! H√£y ki·ªÉm tra email " + guestEmail + ".", "OTP Sent", JOptionPane.INFORMATION_MESSAGE);
                guestClicked = true;
                showFakeGmailWindow(frame, guestEmail, generatedOTP);
                showOTPInputDialog(frame, generatedOTP);
            }
        });
 
        checkHuman.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                if (!checkHuman.isSelected()) {
                    captchaVerified = false;
                    return;
                }

                currentCaptchaText = generateCaptchaText(6);
                BufferedImage captchaImage = generateCaptchaImage(currentCaptchaText);

                JPanel captchaPanel = new JPanel(new BorderLayout());
                JLabel captchaLabel = new JLabel(new ImageIcon(captchaImage));
                JButton btnRefreshCaptcha = new JButton("üîÅ");

                btnRefreshCaptcha.addActionListener(new ActionListener() {
                    @Override
                    public void actionPerformed(ActionEvent e) {
                        currentCaptchaText = generateCaptchaText(6);
                        BufferedImage newCaptchaImage = generateCaptchaImage(currentCaptchaText);
                        captchaLabel.setIcon(new ImageIcon(newCaptchaImage));
                    }
                });

                captchaPanel.add(captchaLabel, BorderLayout.CENTER);
                captchaPanel.add(btnRefreshCaptcha, BorderLayout.EAST);

                String enteredCaptcha = JOptionPane.showInputDialog(frame, captchaPanel, "X√°c nh·∫≠n CAPTCHA", JOptionPane.QUESTION_MESSAGE);

                if (enteredCaptcha != null && enteredCaptcha.equalsIgnoreCase(currentCaptchaText)) {
                    captchaVerified = true;
                    checkHuman.setSelected(true);
                    JOptionPane.showMessageDialog(frame, "CAPTCHA ƒë√∫ng!", "X√°c nh·∫≠n th√†nh c√¥ng", JOptionPane.INFORMATION_MESSAGE);
                } else {
                    captchaVerified = false;
                    checkHuman.setSelected(false);
                    JOptionPane.showMessageDialog(frame, "M√£ CAPTCHA kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.", "L·ªói CAPTCHA", JOptionPane.ERROR_MESSAGE);
                }
            }
        });

        btnLogin.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                String username = textUsername.getText();
                String password = new String(textPassword.getPassword());
        
                if (!captchaVerified) {
                    JOptionPane.showMessageDialog(frame, "B·∫°n ph·∫£i x√°c minh CAPTCHA tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p.", "L·ªói", JOptionPane.ERROR_MESSAGE);
                    return;
                }
        
                // Check if username and password are valid
                if (accountsMap.containsKey(username) && accountsMap.get(username).split(" ")[0].equals(password)) {
                    JOptionPane.showMessageDialog(frame, "Xin ch√†o, " + username + "! ƒêƒÉng nh·∫≠p th√†nh c√¥ng.", "ƒêƒÉng nh·∫≠p th√†nh c√¥ng", JOptionPane.INFORMATION_MESSAGE);
                    textUsername.setText("");
                    textPassword.setText("");
        
                    stoUsername = username;
                    LoginSelection.Minesweeper();
                } else {
                    JOptionPane.showMessageDialog(frame, "T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.", "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", JOptionPane.ERROR_MESSAGE);
                    checkHuman.setSelected(false);
                    captchaVerified = false;
                }
            }
        });
        
        btnExit.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                System.exit(0);
            }
        });
    }

    private static void showOTPInputDialog(JFrame parentFrame, String generatedOTP) {
        JTextField otpInput = new JTextField(6);
        JPanel panel = new JPanel(new BorderLayout());
        panel.add(new JLabel("Nh·∫≠p m√£ OTP:"), BorderLayout.NORTH);
        panel.add(otpInput, BorderLayout.CENTER);
    
        boolean otpValid = false;
        while (!otpValid) {
            int result = JOptionPane.showConfirmDialog(parentFrame, panel, "X√°c nh·∫≠n OTP", JOptionPane.OK_CANCEL_OPTION);
            if (result == JOptionPane.OK_OPTION) {
                String enteredOTP = otpInput.getText();
                if (enteredOTP.equals(generatedOTP)) {
                        if (guestClicked == true) {
                            JOptionPane.showMessageDialog(parentFrame, "ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi t∆∞ c√°ch Guest.", "ƒêƒÉng nh·∫≠p th√†nh c√¥ng", JOptionPane.INFORMATION_MESSAGE);
                            stoUsername = "Guest";
                            LoginSelection.Minesweeper();
                            guestClicked = false;
                        } else {
                            Account account = new Account();
                            account.showGUI();
                        }
                    otpValid = true;
                } 
                 else {
                    JOptionPane.showMessageDialog(parentFrame, "M√£ OTP kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.", "L·ªói OTP", JOptionPane.ERROR_MESSAGE);
                }
            } else {
                break;
            }
        }
    }    

    private static void showFakeGmailWindow(JFrame parentFrame, String email, String otp) {
        JFrame gmailFrame = new JFrame("Gmail - H·ªôp th∆∞ ƒë·∫øn");
        gmailFrame.setSize(400, 300);
        gmailFrame.setResizable(false);
        gmailFrame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        gmailFrame.setLayout(new BorderLayout());
    
        JPanel headerPanel = new JPanel(new GridLayout(4, 1));
        JLabel fromLabel = new JLabel("    T·ª´: no-reply@gmail.eggplant.com");
        JLabel toLabel = new JLabel("    ƒê·∫øn: " + email);
        JLabel dateLabel = new JLabel("    Ng√†y: " + java.time.LocalDateTime.now().format(java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")));
        JLabel subjectLabel = new JLabel("    Ch·ªß ƒë·ªÅ: M√£ OTP c·ªßa b·∫°n");
    
        headerPanel.add(fromLabel);
        headerPanel.add(toLabel);
        headerPanel.add(dateLabel);
        headerPanel.add(subjectLabel);
    
        JLabel otpLabel = new JLabel("M√£ OTP c·ªßa b·∫°n: " + otp, JLabel.CENTER);
        otpLabel.setFont(new Font("Serif", Font.BOLD, 20));
    
        JButton btnOK = new JButton("OK");
        JPanel footerPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        footerPanel.add(btnOK);
    
        gmailFrame.add(headerPanel, BorderLayout.NORTH);
        gmailFrame.add(otpLabel, BorderLayout.CENTER);
        gmailFrame.add(footerPanel, BorderLayout.SOUTH);
    
        gmailFrame.setLocationRelativeTo(null);
        gmailFrame.setLocation(100, 100);
        
        gmailFrame.setVisible(true);
    
        btnOK.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                gmailFrame.dispose();
            }
        });
    }

    private static void loadAccounts(String filename) {
        try (BufferedReader br = new BufferedReader(new FileReader("LoginSimulate/src/" + filename))) {
            String line;
            while ((line = br.readLine()) != null) {
                String[] parts = line.split(" ");
                if (parts.length >= 2) { // C·∫ßn 3 ph·∫ßn ƒë·ªÉ l·∫•y t√™n, m·∫≠t kh·∫©u v√† email
                    String username = parts[0];
                    String password = parts[1];
                    String email = parts[2];
                    accountsMap.put(username, password + " " + email); // L∆∞u m·∫≠t kh·∫©u v√† email
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }    
}